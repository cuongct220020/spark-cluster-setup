version: '3.8'

networks:
  spark-net:
    driver: bridge

volumes:
  zk1-data:
  zk1-log:
  zk2-data:
  zk2-log:
  zk3-data:
  zk3-log:

services:
  # ============================================
  # ZooKeeper Cluster (3 nodes for HA)
  # ============================================

  zookeeper-1:
    image: zookeeper:3.9
    container_name: zookeeper-1
    hostname: zookeeper-1
    networks:
      - spark-net
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181
      ZOO_4LW_COMMANDS_WHITELIST: "*"
    volumes:
      - zk1-data:/data
      - zk1-log:/datalog
    restart: unless-stopped

  zookeeper-2:
    image: zookeeper:3.9
    container_name: zookeeper-2
    hostname: zookeeper-2
    networks:
      - spark-net
    ports:
      - "2182:2181"
    environment:
      ZOO_MY_ID: 2
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181
      ZOO_4LW_COMMANDS_WHITELIST: "*"
    volumes:
      - zk2-data:/data
      - zk2-log:/datalog
    restart: unless-stopped

  zookeeper-3:
    image: zookeeper:3.9
    container_name: zookeeper-3
    hostname: zookeeper-3
    networks:
      - spark-net
    ports:
      - "2183:2181"
    environment:
      ZOO_MY_ID: 3
      ZOO_SERVERS: server.1=zookeeper-1:2888:3888;2181 server.2=zookeeper-2:2888:3888;2181 server.3=zookeeper-3:2888:3888;2181
      ZOO_4LW_COMMANDS_WHITELIST: "*"
    volumes:
      - zk3-data:/data
      - zk3-log:/datalog
    restart: unless-stopped

  # ============================================
  # Spark Master Nodes (3 masters for HA)
  # ============================================

  spark-master-1:
    image: apache/spark:3.5.0
    container_name: spark-master-1
    hostname: spark-master-1
    networks:
      - spark-net
    ports:
      - "7077:7077"
      - "8080:8080"
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=spark-master-1
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
      - SPARK_DAEMON_JAVA_OPTS=-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=zookeeper-1:2181,zookeeper-2:2181,zookeeper-3:2181 -Dspark.deploy.zookeeper.dir=/spark-ha
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
    command: >
      bash -c "
        echo 'Waiting for ZooKeeper to be ready...';
        sleep 10;
        echo 'Starting Spark Master 1...';
        /opt/spark/sbin/start-master.sh;
        tail -f /opt/spark/logs/*
      "
    restart: unless-stopped

  spark-master-2:
    image: apache/spark:3.5.0
    container_name: spark-master-2
    hostname: spark-master-2
    networks:
      - spark-net
    ports:
      - "7078:7077"
      - "8081:8080"
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=spark-master-2
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
      - SPARK_DAEMON_JAVA_OPTS=-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=zookeeper-1:2181,zookeeper-2:2181,zookeeper-3:2181 -Dspark.deploy.zookeeper.dir=/spark-ha
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
    command: >
      bash -c "
        echo 'Waiting for ZooKeeper to be ready...';
        sleep 10;
        echo 'Starting Spark Master 2...';
        /opt/spark/sbin/start-master.sh;
        tail -f /opt/spark/logs/*
      "
    restart: unless-stopped

  spark-master-3:
    image: apache/spark:3.5.0
    container_name: spark-master-3
    hostname: spark-master-3
    networks:
      - spark-net
    ports:
      - "7079:7077"
      - "8082:8080"
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=spark-master-3
      - SPARK_MASTER_PORT=7077
      - SPARK_MASTER_WEBUI_PORT=8080
      - SPARK_DAEMON_JAVA_OPTS=-Dspark.deploy.recoveryMode=ZOOKEEPER -Dspark.deploy.zookeeper.url=zookeeper-1:2181,zookeeper-2:2181,zookeeper-3:2181 -Dspark.deploy.zookeeper.dir=/spark-ha
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
    command: >
      bash -c "
        echo 'Waiting for ZooKeeper to be ready...';
        sleep 10;
        echo 'Starting Spark Master 3...';
        /opt/spark/sbin/start-master.sh;
        tail -f /opt/spark/logs/*
      "
    restart: unless-stopped

  # ============================================
  # Spark Worker Nodes
  # ============================================

  spark-worker-1:
    image: apache/spark:3.5.0
    container_name: spark-worker-1
    hostname: spark-worker-1
    networks:
      - spark-net
    ports:
      - "8083:8081"
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master-1:7077,spark-master-2:7077,spark-master-3:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_WEBUI_PORT=8081
    depends_on:
      - spark-master-1
      - spark-master-2
      - spark-master-3
    command: >
      bash -c "
        echo 'Waiting for Spark Masters...';
        sleep 15;
        echo 'Starting Spark Worker 1...';
        /opt/spark/sbin/start-worker.sh spark://spark-master-1:7077,spark-master-2:7077,spark-master-3:7077;
        tail -f /opt/spark/logs/*
      "
    restart: unless-stopped

  spark-worker-2:
    image: apache/spark:3.5.0
    container_name: spark-worker-2
    hostname: spark-worker-2
    networks:
      - spark-net
    ports:
      - "8084:8081"
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master-1:7077,spark-master-2:7077,spark-master-3:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_WEBUI_PORT=8081
    depends_on:
      - spark-master-1
      - spark-master-2
      - spark-master-3
    command: >
      bash -c "
        echo 'Waiting for Spark Masters...';
        sleep 15;
        echo 'Starting Spark Worker 2...';
        /opt/spark/sbin/start-worker.sh spark://spark-master-1:7077,spark-master-2:7077,spark-master-3:7077;
        tail -f /opt/spark/logs/*
      "
    restart: unless-stopped

  spark-worker-3:
    image: apache/spark:3.5.0
    container_name: spark-worker-3
    hostname: spark-worker-3
    networks:
      - spark-net
    ports:
      - "8085:8081"
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master-1:7077,spark-master-2:7077,spark-master-3:7077
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_WEBUI_PORT=8081
    depends_on:
      - spark-master-1
      - spark-master-2
      - spark-master-3
    command: >
      bash -c "
        echo 'Waiting for Spark Masters...';
        sleep 15;
        echo 'Starting Spark Worker 3...';
        /opt/spark/sbin/start-worker.sh spark://spark-master-1:7077,spark-master-2:7077,spark-master-3:7077;
        tail -f /opt/spark/logs/*
      "
    restart: unless-stopped